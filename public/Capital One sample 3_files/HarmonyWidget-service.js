define(["require","exports","angular"],function(a,e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function a(a,e,n,r,i,o){var s=this;this._=a,this.$log=e,this.EaseConstant=n,this.messagingService=r,this.EaseErrorMessageFactory=i,this.pubsubService=o,this._harmonyData={},this.getHarmonyData=function(){if(s.harmonyDataPromise)return s.harmonyDataPromise;var a=s.messagingService.generateTileMessagePlacement(),e=s.messagingService.generateRequestPayload(null,1,a),t=s.EaseConstant.busEvtId.harmonyWidget.harmonyPresentedId;return s.harmonyDataPromise=s.messagingService.getTileMessage(t,e).then(function(a){var e=s.EaseErrorMessageFactory.getEaseDisplayError(a);if(e)return void s._handleError(s.EaseErrorMessageFactory.getErrorMessage(e));if(a.global&&a.global.length>0)try{var t=a.global[0].article.section;if(s.parseSharedData(a,t),"Feature"===s._harmonyData.messageLayout)return s.parseFeature(t);if("Offers"===s._harmonyData.messageLayout)return s.parseOffer(t)}catch(n){return void s._handleError(n)}}),s.harmonyDataPromise},this.setHarmonyData=function(a){t.extend(s._harmonyData,a)},this.isEligibleForHarmonyWidget=function(){return s.getHarmonyData().then(function(){return s.isEligible},function(){return!1})},this.formatAndSendAnalytics=function(a){var e="Feature"===s._harmonyData.messageLayout?"feature template widget":"offers widget",t=e+":"+a+":link";s.pubsubService.pubsubTrackAnalytics({name:t})},this.postToHarmony=function(a,e,t){s.messagingService.responseMessageApi(a,e,"summary",t)},this.parseSharedData=function(a,e){s._harmonyData.messageLayout=a.global[0].messageLayout,s._harmonyData.harmonyUrl=a.global[0].responseUrlHref,s._harmonyData.widgetId=a.global[0].messageId;var t=e[0].media,n=s._.find(t,function(a){return"primary_small"===a.type});s._harmonyData.smallImage=n&&n.path?n.path:null,s._harmonyData.mediumImage=s._.find(t,function(a){return"primary_medium"===a.type}).path,s._harmonyData.largeImage=s._.find(t,function(a){return"primary_large"===a.type}).path,s._harmonyData.icon=null;var r=e[0].button,i=s._.find(r,function(a){return"accept"===a.responseType});s._harmonyData.acceptButtonText=i.value,s._harmonyData.declineButtonText=s._.find(r,function(a){return"decline"===a.responseType}).value;var o=i.link.path,l=i.addText;s._harmonyData.widgetTitle=e[0].headline;var m=l?l:null;s._harmonyData.acceptLink=s.messagingService.formatLinkWithPathParams(o,m);var u=i.overRideType;s._harmonyData.isAcceptLinkExternal=u&&"EXTERNAL"===u?!0:!1,s._harmonyData.subHeadlineDismissed=e[1].headline,s._harmonyData.textContentDismissed=e[1].body,s._harmonyData.imgDismissed=s._.find(e[1].media,function(a){return"thumbnail"===a.type}).path;var h=e[1].button;s._harmonyData.exploreMoreText=h.length>0?h[0].value:null,s._harmonyData.exploreMoreLink=h.length>0?h[0].link.path:null,s._harmonyData.isDismissed=!1,s.isEligible=!0},this.parseOffer=function(a){return s._harmonyData.useInlineCallToActionButtons=!0,s._harmonyData.subHeadline=a[0].subheadline?a[0].subheadline.slice(0,18):null,s._harmonyData.textContent=a[0].body,s._harmonyData.imageClass="ease-widget__image--full-bleed",s._harmonyData.widgetClass="offersWidget",s._harmonyData},this.parseFeature=function(a){return s._harmonyData.imageClass="ease-widget__image--default",s._harmonyData.widgetClass="featureTemplateWidget",s._harmonyData.useInlineCallToActionButtons=!1,s._harmonyData.acceptCtaButtonText=s._harmonyData.useInlineCallToActionButtons?"":s._harmonyData.acceptButtonText,s._harmonyData.declineCtaButtonText=s._harmonyData.useInlineCallToActionButtons?"":s._harmonyData.declineButtonText,s._harmonyData.useInlineCallToActionButtons=!1,s._harmonyData.textContent=a[0].body.slice(0,115),s._harmonyData},this._handleError=function(a){s.isEligible=!1,s.harmonyDataPromise=null,s.$log.error("Harmony Widget Error",a)}}return a.$inject=["_","$log","EaseConstant","messagingService","EaseErrorMessageFactory","pubsubService"],a}();e.HarmonyWidgetService=n,t.module("WidgetAreaModule").service("HarmonyWidgetService",n)});